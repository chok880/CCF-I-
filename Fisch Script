-- 📌 ตั้งค่าพื้นฐาน
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local VirtualInputManager = game:GetService("VirtualInputManager")
local GuiService = game:GetService("GuiService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- โหลด Luna UI
local Luna = loadstring(game:HttpGet("https://raw.githubusercontent.com/Nebula-Softworks/Luna-Interface-Suite/refs/heads/master/source.lua"))()

local Window = Luna:CreateWindow({
    Name = "CHOK HUB 🎣",
    Subtitle = "Fishing Script",
    LoadingEnabled = true,
    LoadingTitle = "CHOK HUB",
    LoadingSubtitle = "by Nebula Softworks",
    ConfigSettings = {
        ConfigFolder = "CHOK HUB Config"
    },
    KeySystem = false
})

Window:CreateHomeTab({
    SupportedExecutors = {"Synapse X", "Krnl", "Fluxus", "Script-Ware"},
    Icon = 1
})

local Tab_Main = Window:CreateTab({
    Name = "เมนูหลัก",
    Icon = "view_in_ar",
    ImageSource = "Material"
})

------------------------------------------------------------
-- 🐟 Auto Fish
------------------------------------------------------------
Tab_Main:CreateToggle({
    Name = "🎯⚡🎣 ปลาอัตโนมัติ",
    CurrentValue = false,
    Callback = function(state)
        _G.AutoFishAll = state
        task.spawn(function()
            while _G.AutoFishAll and task.wait(0.1) do
                if not Char or not Char.Parent then break end

                -- AutoCast
                local Rod = Char:FindFirstChildOfClass("Tool")
                if Rod and Rod:FindFirstChild("events") and Rod.events:FindFirstChild("cast") then
                    Rod.events.cast:FireServer(100, 1, false, Vector3.zero, tick(), "Auto")
                end

                -- AutoShake
                local shakeUI = LocalPlayer.PlayerGui:FindFirstChild("shakeui")
                if shakeUI and shakeUI.Enabled then
                    local safezone = shakeUI:FindFirstChild("safezone")
                    local button = safezone and safezone:FindFirstChild("button")
                    if button and button:IsA("ImageButton") and button.Visible then
                        GuiService.SelectedObject = button
                        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                    end
                end

                -- AutoReel
                for _, gui in ipairs(LocalPlayer.PlayerGui:GetChildren()) do
                    if gui:IsA("ScreenGui") and gui.Name == "reel" and gui:FindFirstChild("bar") then
                        ReplicatedStorage.events.reelfinished:FireServer(100, true, false, Vector3.zero, tick(), "Auto")
                    end
                end

                -- Auto Equip Rod
                for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
                    if tool:IsA("Tool") and tool.Name:lower():find("rod") then
                        LocalPlayer.Character.Humanoid:EquipTool(tool)
                    end
                end
            end
        end)
    end
})

------------------------------------------------------------
-- 📍 ยืนที่เดิม
------------------------------------------------------------
Tab_Main:CreateToggle({
    Name = "📍 ยืนที่เดิม",
    CurrentValue = false,
    Callback = function(state)
        _G.AutoReturn = state
        if state then
            local startPos = Char.HumanoidRootPart.Position
            local startCFrame = Char.HumanoidRootPart.CFrame -- เก็บทั้งตำแหน่งและทิศทาง
            task.spawn(function()
                while _G.AutoReturn and task.wait(0.2) do
                    if not Char or not Char.Parent then break end
                    -- เช็คทั้งตำแหน่งและทิศทาง
                    local currentPos = Char.HumanoidRootPart.Position
                    local currentCFrame = Char.HumanoidRootPart.CFrame
                    
                    if (currentPos - startPos).Magnitude > 0.02 or 
                       math.abs(currentCFrame.LookVector:Dot(startCFrame.LookVector)) < 0.98 then
                        Char.HumanoidRootPart.CFrame = startCFrame -- คืนทั้งตำแหน่งและทิศทาง
                    end
                end
            end)
        end
    end
})

------------------------------------------------------------
-- ⏳ Anti AFK
------------------------------------------------------------
Tab_Main:CreateToggle({
    Name = "⏳ ป้องกัน AFK",
    CurrentValue = false,
    Callback = function(state)
        _G.AntiAFK = state
        if state then
            task.spawn(function()
                while _G.AntiAFK and task.wait(60) do
                    -- ส่ง input เพื่อป้องกัน AFK
                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.LeftShift, false, game)
                    task.wait(0.1)
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.LeftShift, false, game)
                end
            end)
        end
    end
})

------------------------------------------------------------
-- 🚀 Auto Sell Fish
------------------------------------------------------------
Tab_Main:CreateToggle({
    Name = "🚀 ขายปลาอัตโนมัติ",
    CurrentValue = false,
    Callback = function(state)
        _G.AutoSell = state
        if state then
            task.spawn(function()
                while _G.AutoSell and task.wait(5) do
                    -- หา NPC ขายปลา
                    local sellNPC = workspace:FindFirstChild("SellNPC") or workspace:FindFirstChild("FishSeller")
                    if sellNPC then
                        -- เดินไปหา NPC
                        local humanoid = Char:FindFirstChild("Humanoid")
                        if humanoid then
                            humanoid:MoveTo(sellNPC.Position)
                            task.wait(2)
                            
                            -- ขายปลา
                            if ReplicatedStorage:FindFirstChild("events") and ReplicatedStorage.events:FindFirstChild("sell") then
                                ReplicatedStorage.events.sell:FireServer()
                            end
                        end
                    end
                end
            end)
        end
    end
})

------------------------------------------------------------
-- 💳 เครดิต
------------------------------------------------------------
local Tab_Credit = Window:CreateTab({
    Name = "เครดิต",
    Icon = "info",
    ImageSource = "Material"
})

Tab_Credit:CreateLabel({
    Text = "💻 Script by CHOK HUB",
    Style = 1
})

Tab_Credit:CreateLabel({
    Text = "🎣 Fishing Automation Script",
    Style = 2
})

Tab_Credit:CreateLabel({
    Text = "⚡ แก้ไขและปรับปรุงแล้ว",
    Style = 2
})

-- 📌 เพิ่มฟังก์ชันสำหรับอัพเดท Character เมื่อ Respawn
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Char = newChar
    task.wait(1) -- รอให้ Character โหลดเสร็จ
end)
